# Requirements Document

## Introduction
本仕様は、GitLabのコミットデータから、ユーザー（コミット作成者）ごとの月次集計（追加行数と削除行数）を生成し、永続化する機能を定義します。これにより、ユーザーの生産性を月単位で分析できるようになります。

## Requirements

### Requirement 1: 月次集計データの永続化
**Objective:** As a システム管理者, I want ユーザーごとの月次集計データをデータベースに永続化する, so that 集計データを効率的に取得・分析できる

#### Acceptance Criteria
1. When 月次集計データを保存する場合, the 集計システム shall ユーザー（author_email）、プロジェクトID、ブランチ名、年、月をキーとして集計データを保存する
2. When 月次集計データを保存する場合, the 集計システム shall 追加行数の合計と削除行数の合計を保存する
3. When 同一のユーザー・プロジェクト・ブランチ・年月の集計データが既に存在する場合, the 集計システム shall 既存のデータを更新する（重複を作成しない）
4. When 月次集計データを保存する場合, the 集計システム shall 集計対象のコミット数を記録する
5. When 月次集計データを保存する場合, the 集計システム shall author_nameも保存する（表示時に使用するため）
6. The 集計システム shall タイムゾーンを考慮して年月を判定する（コミット日時を基準に年月を決定）

### Requirement 2: コミットデータからの集計生成
**Objective:** As a システム管理者, I want 既存のコミットデータから月次集計を生成する, so that 過去のコミットデータを分析できる

#### Acceptance Criteria
1. When コミットデータから集計を生成する場合, the 集計システム shall 指定されたプロジェクトIDとブランチ名のコミットを対象とする
2. When コミットデータから集計を生成する場合, the 集計システム shall コミットのauthor_emailでユーザーを識別する
3. When コミットデータから集計を生成する場合, the 集計システム shall コミットのcommitted_dateから年月を抽出する
4. When コミットデータから集計を生成する場合, the 集計システム shall 同一ユーザー・同一年月のコミットのadditionsとdeletionsを合計する
5. When コミットデータから集計を生成する場合, the 集計システム shall 集計対象のコミット数をカウントする
6. When コミットデータから集計を生成する場合, the 集計システム shall 同一ユーザーのコミットからauthor_nameを取得して集計データに保存する
7. When 集計生成中にエラーが発生した場合, the 集計システム shall エラーメッセージを返却し、部分的な集計データは保存しない
8. When 集計を生成する場合, the 集計システム shall 先月までのデータのみを集計対象とする（今月のデータは集計しない）
9. When 集計を生成する場合, the 集計システム shall 既に集計が完了している月はスキップし、最終集計月以降のデータのみを対象とする
10. When 集計を生成する場合, the 集計システム shall 最終集計月から先月までの期間のデータを集計する
11. When コミットの収集や再収集が完了した場合, the 集計システム shall 自動的に集計処理を実行する

### Requirement 3: 集計データの取得
**Objective:** As a ユーザー, I want 月次集計データを取得する, so that ユーザーの生産性を月単位で確認できる

#### Acceptance Criteria
1. When 集計データを取得する場合, the 集計システム shall 指定されたプロジェクトIDとブランチ名の集計データを返却する
2. When 集計データを取得する場合, the 集計システム shall 指定された年月範囲の集計データを返却する
3. When 集計データを取得する場合, the 集計システム shall 指定されたユーザー（author_email）の集計データを返却する
4. When 集計データを取得する場合, the 集計システム shall ユーザーごと、年月ごとにグループ化された集計データを返却する
5. When 集計データが存在しない場合, the 集計システム shall 空のコレクションを返却する

### Requirement 4: 集計の自動更新
**Objective:** As a システム管理者, I want 新しいコミットが追加されたときに集計を自動更新する, so that 集計データが常に最新の状態を保つ

#### Acceptance Criteria
1. When コミットの収集や再収集が完了した場合, the 集計システム shall 該当するプロジェクト・ブランチの集計処理を自動実行する
2. When 集計処理を実行する場合, the 集計システム shall 最終集計月から先月までの期間のデータを集計する
3. When 集計データが存在しない場合, the 集計システム shall 新しい集計データを作成する
4. When 集計データが既に存在する場合, the 集計システム shall 既存の集計データを更新する（重複を作成しない）
5. When 集計データを更新する場合, the 集計システム shall 集計対象のコミット数を更新する
6. When 集計更新中にエラーが発生した場合, the 集計システム shall エラーログを記録し、コミットの保存処理は継続する（集計更新の失敗がコミット保存を妨げない）

### Requirement 5: 集計データの画面表示
**Objective:** As a ユーザー, I want 月次集計データを視覚的に確認する, so that ユーザーの生産性を月単位で分析できる

#### Acceptance Criteria
1. When 集計データ画面を表示する場合, the 集計システム shall 棒グラフと表でデータを表示する
2. When 集計データ画面を表示する場合, the 集計システム shall 「プロジェクトID：ブランチ名」のセレクトボックスを提供する
3. When 集計データ画面を表示する場合, the 集計システム shall 「年」のセレクトボックスを提供する
4. When セレクトボックスの値が変更された場合, the 集計システム shall 表示データを切り替える
5. When 棒グラフを表示する場合, the 集計システム shall 横軸に月、縦軸に行数を表示する
6. When 棒グラフを表示する場合, the 集計システム shall 追加行を青色、削除行を赤色で表示する
7. When 棒グラフを表示する場合, the 集計システム shall 追加行と削除行を積み上げ棒グラフで表示する
8. When 棒グラフを表示する場合, the 集計システム shall 複数ユーザーを集合縦棒で表示する
9. When ユーザー名を表示する場合, the 集計システム shall 保存されたauthor_nameを使用し、名前がない場合は"Unknown"を表示する
10. When データを表示する場合, the 集計システム shall プロジェクトID、ブランチ名、ユーザーの昇順でソートする
11. When 表を表示する場合, the 集計システム shall 縦軸にユーザー、横軸に1月、2月、3月のように月を表示する
12. When 表を表示する場合, the 集計システム shall 表のセルに合計行数（追加行数と削除行数の合計）を表示する

